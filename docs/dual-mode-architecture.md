# 双模式切换架构设计

> 支持SQLBot原版和Claude Code版本的无缝切换
> 设计时间：2026-02-08

---

## 📋 核心思路

### 双模式设计

| 模式 | 描述 | 组件 |
|------|------|------|
| **模式1：SQLBot原版** | SQLBot完整的RAG + Prompt构建 + LLM生成SQL | SQLBot后端（完整）|
| **模式2：Claude Code版** | Claude Code全掌控（RAG + Prompt + SQL生成） | SQLBot简化API + Claude Code |

### 切换方式

**通过系统配置切换**：
- 在SQLBot数据库中添加配置项：`chat_mode`
- 值：`sqlbot`（原版）或 `claude_code`（Claude Code版）
- 切换后立即生效（无需重启）

---

## 🏗️ 架构设计

```
┌─────────────────────────────────────────────────────┐
│                 SQLBot 前端                     │
│              (React - 无需修改）                  │
│                                                  │
│  用户在前端输入问题："垂管系统数量"               │
└───────────────────┬───────────────────────────────┘
                    │ HTTP/WebSocket
                    ▼
┌─────────────────────────────────────────────────────┐
│              SQLBot 后端                     │
│              (FastAPI - 添加模式路由）           │
│                                                  │
│  ┌─────────────────────────────────────────┐   │
│  │      模式路由（新增）                │   │
│  │      /api/chat/question              │   │
│  ├─────────────────────────────────────────┤   │
│  │  1. 读取配置：chat_mode             │   │
│  │  2. 判断模式                        │   │
│  │     - sqlbot: 调用原版逻辑         │   │
│  │     - claude_code: 调用简化API     │   │
│  │  3. 返回统一结果                    │   │
│  └─────────────────────────────────────────┘   │
│                                                  │
│  ┌────────────────────┬───────────────────────┐   │
│  │  模式1：原版      │  模式2：Claude Code版  │   │
│  │  （保留）         │  （新增）               │   │
│  ├────────────────────┼───────────────────────┤   │
│  │  RAG增强层       │  简化API               │   │
│  │  Prompt构建层    │  /claude-bridge/chat   │   │
│  │  LLM调用层       │  → 调用Claude Code    │   │
│  │  数据访问层       │  SQL执行               │   │
│  │  图表生成         │  图表生成               │   │
│  └────────────────────┴───────────────────────┘   │
│                                                  │
│  ┌─────────────────────────────────────────┐   │
│  │      模式管理API（新增）             │   │
│  │      /api/system/mode              │   │
│  ├─────────────────────────────────────────┤   │
│  │  GET /mode: 获取当前模式           │   │
│  │  PUT /mode: 切换模式               │   │
│  │  GET /mode/status: 获取模式状态    │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                    │
                    │ 模式2时调用
                    ▼
┌─────────────────────────────────────────────────────┐
│           Claude Code Agent              │
│                                                  │
│  步骤1：读取MD文件                             │
│  ├─ read skills/sqlbot-knowledge/SCHEMA.md     │
│  ├─ read skills/sqlbot-knowledge/TERMINOLOGY.md  │
│  ├─ read skills/sqlbot-knowledge/EXAMPLES.md     │
│  └─ read skills/sqlbot-knowledge/PROMPT.md       │
│                                                  │
│  步骤2：RAG检索 + Prompt构建 + SQL生成      │
│  └─ 返回SQL给SQLBot                            │
└─────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────┐
│           Skill目录（MD文件）                    │
│           (Claude Code读取）                      │
│                                                  │
│  📄 skills/sqlbot-knowledge/                     │
│    ├─ SCHEMA.md              (表结构)          │
│    ├─ TERMINOLOGY.md         (术语库)          │
│    ├─ EXAMPLES.md            (SQL示例)         │
│    ├─ PROMPT.md              (自定义Prompt)   │
│    └─ RELATIONS.md           (表关系)          │
└─────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────┐
│              PostgreSQL 数据库                 │
│                                                  │
│  ├─→ 业务数据表（苏政源一本账）                │
│  ├─→ SQLBot 系统表                         │
│  ├─→ 系统配置表（新增：sys_config）            │
│  │   - chat_mode: 'sqlbot' | 'claude_code' │
│  ├─→ terminology (术语库)                    │
│  ├─→ data_training (SQL示例)                │
│  └─→ ai_model_detail (LLM配置)              │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 实施步骤

### 阶段 1：创建系统配置表（30分钟）

**SQL**：

```sql
-- 创建系统配置表
CREATE TABLE IF NOT EXISTS sys_config (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    config_key VARCHAR(255) NOT NULL UNIQUE,
    config_value TEXT,
    config_type VARCHAR(50) DEFAULT 'string',
    description VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 插入默认配置
INSERT INTO sys_config (config_key, config_value, config_type, description) VALUES
('chat_mode', 'sqlbot', 'string', '聊天模式：sqlbot(原版) 或 claude_code(Claude Code版）'),
('claude_code_api_url', 'http://localhost:6800/v1/chat/completions', 'string', 'Claude Code API地址'),
('claude_code_api_key', '', 'string', 'Claude Code API Key')
ON CONFLICT (config_key) DO NOTHING;

-- 创建索引
CREATE INDEX idx_sys_config_key ON sys_config(config_key);
```

**ORM模型**：`common/models/system_config.py`

```python
# common/models/system_config.py

from typing import Optional
from sqlmodel import SQLModel, Field
from datetime import datetime


class SysConfig(SQLModel, table=True):
    """系统配置表"""
    
    __tablename__ = "sys_config"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    config_key: str = Field(max_length=255, description="配置键")
    config_value: Optional[str] = Field(default=None, description="配置值")
    config_type: str = Field(max_length=50, default="string", description="配置类型")
    description: Optional[str] = Field(max_length=500, description="描述")
    created_at: Optional[datetime] = Field(default=None, description="创建时间")
    updated_at: Optional[datetime] = Field(default=None, description="更新时间")


class SysConfigUpdate(SQLModel):
    """更新系统配置"""
    
    config_value: str
    description: Optional[str] = None
```

---

### 阶段 2：创建模式管理API（30分钟）

**文件**：`apps/system/api/mode.py`

**代码**：

```python
# apps/system/api/mode.py

"""
模式管理API
用于切换SQLBot原版和Claude Code版
"""

from typing import Optional
from fastapi import APIRouter, HTTPException
from sqlmodel import Session, select

from common.models.system_config import SysConfig, SysConfigUpdate
from common.core.deps import SessionDep
from common.utils.utils import SQLBotLogUtil

router = APIRouter(tags=["Mode Management"], prefix="/api/system/mode")


@router.get("", summary="获取当前模式")
def get_current_mode(session: SessionDep):
    """
    获取当前聊天模式
    
    Returns:
        {
            "mode": "sqlbot" | "claude_code",
            "mode_name": "SQLBot原版" | "Claude Code版",
            "updated_at": "2026-02-08 11:30:00"
        }
    """
    # 读取配置
    config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "chat_mode")
    ).first()
    
    if not config:
        # 默认模式
        return {
            "mode": "sqlbot",
            "mode_name": "SQLBot原版",
            "updated_at": None
        }
    
    mode = config.config_value or "sqlbot"
    
    return {
        "mode": mode,
        "mode_name": "SQLBot原版" if mode == "sqlbot" else "Claude Code版",
        "updated_at": config.updated_at
    }


@router.put("", summary="切换模式")
def switch_mode(
    session: SessionDep,
    mode_update: SysConfigUpdate
):
    """
    切换聊天模式
    
    Args:
        mode_update: 模式配置
            {
                "config_value": "sqlbot" | "claude_code",
                "description": "说明（可选）"
            }
    
    Returns:
        {
            "success": true,
            "mode": "sqlbot" | "claude_code",
            "message": "已切换到SQLBot原版" | "已切换到Claude Code版"
        }
    """
    # 验证模式值
    mode = mode_update.config_value
    if mode not in ["sqlbot", "claude_code"]:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid mode: {mode}. Must be 'sqlbot' or 'claude_code'"
        )
    
    # 查询现有配置
    config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "chat_mode")
    ).first()
    
    if config:
        # 更新配置
        from datetime import datetime
        config.config_value = mode
        config.updated_at = datetime.now()
        if mode_update.description:
            config.description = mode_update.description
        session.add(config)
    else:
        # 插入新配置
        from datetime import datetime
        new_config = SysConfig(
            config_key="chat_mode",
            config_value=mode,
            config_type="string",
            description=mode_update.description or f"聊天模式：{mode}",
            created_at=datetime.now(),
            updated_at=datetime.now()
        )
        session.add(new_config)
    
    session.commit()
    
    SQLBotLogUtil.info(f"Chat mode switched to: {mode}")
    
    return {
        "success": True,
        "mode": mode,
        "message": f"已切换到{'SQLBot原版' if mode == 'sqlbot' else 'Claude Code版'}"
    }


@router.get("/status", summary="获取模式状态")
def get_mode_status(session: SessionDep):
    """
    获取模式状态（包含详细信息）
    
    Returns:
        {
            "current_mode": "sqlbot" | "claude_code",
            "current_mode_name": "SQLBot原版" | "Claude Code版",
            "available_modes": ["sqlbot", "claude_code"],
            "mode_descriptions": {
                "sqlbot": "SQLBot完整流程（RAG + Prompt构建 + LLM生成SQL）",
                "claude_code": "Claude Code全掌控（RAG检索 + Prompt构建 + SQL生成）"
            },
            "claude_code_config": {
                "api_url": "http://localhost:6800/v1/chat/completions",
                "api_key_configured": true | false
            },
            "updated_at": "2026-02-08 11:30:00"
        }
    """
    # 读取当前模式
    current_config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "chat_mode")
    ).first()
    
    current_mode = current_config.config_value if current_config else "sqlbot"
    
    # 读取Claude Code配置
    api_url_config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "claude_code_api_url")
    ).first()
    
    api_key_config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "claude_code_api_key")
    ).first()
    
    return {
        "current_mode": current_mode,
        "current_mode_name": "SQLBot原版" if current_mode == "sqlbot" else "Claude Code版",
        "available_modes": ["sqlbot", "claude_code"],
        "mode_descriptions": {
            "sqlbot": "SQLBot完整流程（RAG + Prompt构建 + LLM生成SQL）",
            "claude_code": "Claude Code全掌控（RAG检索 + Prompt构建 + SQL生成）"
        },
        "claude_code_config": {
            "api_url": api_url_config.config_value if api_url_config else None,
            "api_key_configured": bool(api_key_config and api_key_config.config_value)
        },
        "updated_at": current_config.updated_at if current_config else None
    }
```

---

### 阶段 3：修改主路由，支持模式判断（1小时）

**文件**：`apps/chat/api/chat.py`

**修改**：

```python
# apps/chat/api/chat.py

# 导入模式管理
from common.models.system_config import SysConfig
from common.core.deps import SessionDep

# 在现有的chat路由中添加模式判断
@router.post("/question", summary="用户提问（支持双模式）")
async def chat_question(
    session: SessionDep,
    current_user: CurrentUser,
    chat_question: ChatQuestion,
    current_assistant: CurrentAssistant
):
    """
    用户提问（根据模式选择处理方式）
    """
    # 步骤1：读取当前模式
    mode_config = session.exec(
        select(SysConfig).where(SysConfig.config_key == "chat_mode")
    ).first()
    
    current_mode = mode_config.config_value if mode_config else "sqlbot"
    
    SQLBotLogUtil.info(f"Current chat mode: {current_mode}")
    
    # 步骤2：根据模式选择处理方式
    if current_mode == "claude_code":
        # 模式2：Claude Code版
        return await _chat_with_claude_code(
            session=session,
            current_user=current_user,
            chat_question=chat_question,
            current_assistant=current_assistant
        )
    else:
        # 模式1：SQLBot原版（保留原有逻辑）
        return await _chat_with_sqlbot(
            session=session,
            current_user=current_user,
            chat_question=chat_question,
            current_assistant=current_assistant
        )


async def _chat_with_claude_code(
    session: SessionDep,
    current_user: CurrentUser,
    chat_question: ChatQuestion,
    current_assistant: CurrentAssistant
):
    """
    模式2：通过Claude Code生成SQL
    
    复用方案F的逻辑
    """
    # 调用Claude Code Bridge API
    from apps.claude_bridge.api.claude_bridge import chat_with_claude_code
    
    return await chat_with_claude_code(
        session=session,
        current_user=current_user,
        question=chat_question.question,
        chat_id=chat_question.chat_id,
        datasource_id=chat_question.datasource_id
    )


async def _chat_with_sqlbot(
    session: SessionDep,
    current_user: CurrentUser,
    chat_question: ChatQuestion,
    current_assistant: CurrentAssistant
):
    """
    模式1：SQLBot原版（保留原有逻辑）
    
    这里保留SQLBot原有的LLMService处理逻辑
    """
    # 保留原有的逻辑
    from apps.chat.task.llm import LLMService
    
    llm_service = await LLMService.create(session, current_user, chat_question, current_assistant)
    llm_service.run_chat_task_async(session)
    
    # 返回结果
    return StreamingResponse(llm_service.await_result(), media_type="text/event-stream")
```

---

### 阶段 4：注册路由（15分钟）

**文件**：`backend/main.py`

**修改**：

```python
# backend/main.py

# 导入新的路由
from apps.system.api.mode import router as mode_router
from apps.claude_bridge.api.claude_bridge import router as claude_bridge_router

# 注册路由
app.include_router(mode_router)
app.include_router(claude_bridge_router)
```

---

### 阶段 5：前端添加模式切换UI（30分钟）

**文件**：`frontend/src/components/ModeSwitch.tsx`（示例）

**代码**：

```typescript
// frontend/src/components/ModeSwitch.tsx

import React, { useState, useEffect } from 'react';

export const ModeSwitch: React.FC = () => {
  const [currentMode, setCurrentMode] = useState<'sqlbot' | 'claude_code'>('sqlbot');
  const [loading, setLoading] = useState(false);

  // 加载当前模式
  useEffect(() => {
    fetchCurrentMode();
  }, []);

  const fetchCurrentMode = async () => {
    const response = await fetch('/api/system/mode');
    const data = await response.json();
    setCurrentMode(data.mode);
  };

  const switchMode = async (mode: 'sqlbot' | 'claude_code') => {
    setLoading(true);
    try {
      const response = await fetch('/api/system/mode', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          config_value: mode,
          description: `切换到${mode === 'sqlbot' ? 'SQLBot原版' : 'Claude Code版'}`,
        }),
      });

      const data = await response.json();

      if (data.success) {
        setCurrentMode(mode);
        alert(data.message);
      }
    } catch (error) {
      alert('切换失败');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="mode-switch">
      <h3>聊天模式</h3>
      <div className="mode-buttons">
        <button
          className={currentMode === 'sqlbot' ? 'active' : ''}
          onClick={() => switchMode('sqlbot')}
          disabled={loading}
        >
          SQLBot原版
        </button>
        <button
          className={currentMode === 'claude_code' ? 'active' : ''}
          onClick={() => switchMode('claude_code')}
          disabled={loading}
        >
          Claude Code版
        </button>
      </div>
      {loading && <div className="loading">切换中...</div>}
    </div>
  );
};
```

---

### 阶段 6：配置同步到MD（已完成的方案D）

**文件**：`apps/config_sync/sync_config_to_md.py`

**已创建**：
- ✅ 同步脚本
- ✅ MD文件结构

---

## 🎯 双模式对比

### 模式1：SQLBot原版

| 特性 | 说明 |
|------|------|
| **RAG检索** | SQLBot后端（Embedding + 向量搜索）|
| **Prompt构建** | SQLBot后端（自动注入上下文）|
| **SQL生成** | SQLBot LLM（OpenAI/通义千问/VLLM）|
| **优势** | 100%保留原有逻辑，稳定可靠 |
| **劣势** | 不使用Claude Code |

### 模式2：Claude Code版

| 特性 | 说明 |
|------|------|
| **RAG检索** | Claude Code（直接读取MD文件）|
| **Prompt构建** | Claude Code（自己组合）|
| **SQL生成** | Claude Code（自己推理）|
| **优势** | Claude Code全掌控，可扩展性强 |
| **劣势** | 需要Claude Code运行 |

---

## 🚀 使用方式

### 通过API切换

```bash
# 获取当前模式
curl http://localhost:8000/api/system/mode

# 切换到Claude Code版
curl -X PUT http://localhost:8000/api/system/mode \
  -H "Content-Type: application/json" \
  -d '{"config_value": "claude_code"}'

# 切换到SQLBot原版
curl -X PUT http://localhost:8000/api/system/mode \
  -H "Content-Type: application/json" \
  -d '{"config_value": "sqlbot"}'

# 获取模式状态
curl http://localhost:8000/api/system/mode/status
```

### 通过前端切换

在SQLBot前端添加模式切换按钮：

```
[聊天界面]

┌─────────────────────────────────────┐
│  [输入问题: 垂管系统数量]        │
│  [发送]                          │
└─────────────────────────────────────┘

[模式切换]

┌─────────────────────────────────────┐
│  当前模式: Claude Code版           │
│  [切换到SQLBot原版]  [切换到Claude Code版] │
└─────────────────────────────────────┘
```

---

## 📊 实施工作量

| 阶段 | 任务 | 时间 |
|------|------|------|
| 第1步 | 创建系统配置表 | 30 分钟 |
| 第2步 | 创建模式管理API | 30 分钟 |
| 第3步 | 修改主路由（模式判断） | 1 小时 |
| 第4步 | 注册路由 | 15 分钟 |
| 第5步 | 前端模式切换UI | 30 分钟 |
| 第6步 | 配置同步到MD（方案D，已完成） | 1.5 小时 |
| 第7步 | 测试验证 | 30 分钟 |
| **总计** | | **5.5 小时** |

---

## 🎯 优势

### 1. 无缝切换

- ✅ 即时切换（无需重启）
- ✅ 对用户透明（前端显示当前模式）
- ✅ 配置持久化（数据库存储）

### 2. 双模式共存

- ✅ SQLBot原版：稳定可靠
- ✅ Claude Code版：可扩展性强
- ✅ 可以随时切换，对比效果

### 3. 低风险

- ✅ 保留原有逻辑（模式1）
- ✅ 新增模式（模式2）独立
- ✅ 出问题可快速回退

---

## 📋 检查清单

### 实施前检查

- [ ] 已备份SQLBot数据库
- [ ] 已完成方案D（配置同步到MD）
- [ ] 已完成方案F（Claude Code简化API）
- [ ] 已启动OpenClaw Gateway

### 实施后检查

- [ ] 系统配置表已创建
- [ ] 模式管理API已创建
- [ ] 主路由已修改（支持模式判断）
- [ ] 路由已注册
- [ ] 前端模式切换UI已添加
- [ ] 测试模式1（SQLBot原版）
- [ ] 测试模式2（Claude Code版）
- [ ] 测试模式切换
- [ ] 测试回退

---

## 🚀 下一步

**实施建议**：
1. 先完成方案D（配置同步到MD）
2. 再完成方案F（Claude Code简化API）
3. 完成阶段1-5（双模式切换）
4. 测试验证两种模式
5. 部署到生产环境

---

**最后更新**：2026-02-08
